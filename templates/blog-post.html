{% extends "base.html" %}

{% import "related-container.html" as related %}

{% block title %}
  Blog | Cosme
{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ get_url(path="blog-post.css") | safe }}">
  {% if page.extra.cover_image %}
  <link rel="preload" href="{{ page.extra.cover_image }}" as="image" fetchpriority="high">
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="{{ get_url(path="js/exchange-toggle.js") | safe }}"></script>
  <script src="{{ get_url(path="js/blog-post-toc.js") | safe }}"></script>
  <script>
    // Add lazy loading to all images in post content except the first (LCP)
    document.addEventListener('DOMContentLoaded', function() {
      const postImages = document.querySelectorAll('.post-content img');
      postImages.forEach(function(img, index) {
        if (index > 0) { // Skip first image (likely LCP)
          img.setAttribute('loading', 'lazy');
          img.setAttribute('decoding', 'async');
        }
      });
    });
  </script>
{% endblock %}

{% block content %}
  <div class="blog-post">
    {% set post_date_numeric = page.date | date(format="%Y%m%d") | int %}
    {% set now_numeric = now() | date(format="%Y%m%d") | int %}
    
    {% if post_date_numeric > now_numeric %}
      {% set post_date_display = now() | date(format="%B %d, %Y") %}
    {% else %}
      {% set post_date_display = page.date | date(format="%B %d, %Y") %}
    {% endif %}

    <a href="/blog" class="back-link">← Back to all posts</a>
    
    {% if page.taxonomies and page.taxonomies.tags %}
      <div class="tags">
        {% for tag in page.taxonomies.tags %}
          {% if tag | slugify in config.extra.blog_post_tags %}
            <a href="{{ get_taxonomy_url(kind="tags", name=tag) }}" class="tag tag-{{ tag | slugify }}-plain">
              {{ tag | slugify | replace(from="-", to=" ") | title }}
            </a>
          {% else %}
            <a href="{{ get_taxonomy_url(kind="tags", name=tag) }}" class="tag tag-default-plain">
              {{ tag | slugify | replace(from="-", to=" ") | title }}
            </a>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <h1 class="blog-post-title">{{ page.title }}</h1>
    <h3 class="presentation-text">{{ page.description }}</h3>
    
    <div class="post-metadata">
      <span class="post-date">{{ post_date_display }}</span>
      <span class="reading-time">
        {% if page.extra.custom_reading_time and page.extra.custom_word_count %}
          {{ page.extra.custom_reading_time }} min read • {{ page.extra.custom_word_count }} words
        {% else %}
          {{ page.reading_time | default(value="3") }} min read • {{ page.word_count | default(value="0") }} words
        {% endif %}
      </span>
    </div>
    <!-- TOC for mobile - sticky top -->
    <div class="toc-mobile" data-collapsed>
      <button class="toc-header" type="button" aria-expanded="false" aria-controls="toc-list-mobile">
        <span class="toc-title">Table of Contents</span>
        <span class="toc-chevron" aria-hidden="true"></span>
      </button>
      <ul id="toc-list-mobile" class="toc-list"></ul>
      <div class="reading-progress" aria-hidden="true"></div>
    </div>
    <!-- TOC wrapper for desktop sticky behavior -->
    <div class="toc-desktop-wrapper">
      <!-- TOC for desktop - sticky left -->
      <div class="toc-desktop" data-collapsed>
        <div class="toc-desktop-title">On this page</div>
        <ul id="toc-list-desktop" class="toc-list"></ul>
      </div>
    </div>
    <!-- Post content - centered independently -->
    <div class="post-content">
        {{ page.content | safe }}
    </div>
    
    <hr class="footer-rule" />
    {{ related::container(page=page,orderDesc=true) }}
    <hr class="footer-rule-2" />
    
  </div>
{% endblock content %}
